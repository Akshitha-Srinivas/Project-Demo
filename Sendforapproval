import React, { useState, useEffect } from 'react';
import axios from 'axios';

const SendForApproval = ({ batchInfo, transactions }) => {
  const [approvers, setApprovers] = useState([]);
  const [selectedApprovers, setSelectedApprovers] = useState([]);
  const [showModal, setShowModal] = useState(false);
  const [modalMessage, setModalMessage] = useState('');
  const [batchId, setBatchId] = useState(null);

  // Fetch approvers from backend API
  useEffect(() => {
    axios.get('/api/users/approvers') // Change to '/api/users' if you want all users
      .then(response => setApprovers(response.data))
      .catch(error => console.error("Error fetching approvers:", error));
  }, []);

  // Handler for selecting/deselecting approvers
  const handleCheckboxChange = (id) => {
    setSelectedApprovers(prev =>
      prev.includes(id) ? prev.filter(aid => aid !== id) : [...prev, id]
    );
  };

  // Handler for sending batch for approval
  const handleSendForApproval = async () => {
    const payload = {
      batch: {
        ...batchInfo,
        transactions: transactions,
      },
      approvers: selectedApprovers, // array of user IDs
    };

    try {
      const response = await axios.post('/api/payrollbatch/send-for-approval', payload);
      const returnedBatchId = response.data.batchId; // adjust according to backend response
      setBatchId(returnedBatchId);
      setModalMessage(
        `Data sent for approval! Batch ID: ${returnedBatchId}.`
      );
      setShowModal(true);
    } catch (error) {
      setModalMessage('Error: Approval request could not be sent.');
      setShowModal(true);
    }
  };

  const handleCloseModal = () => setShowModal(false);

  return (
    <div>
      <h4>Select Approvers</h4>
      <table border="1" cellPadding="8" style={{marginBottom: '1rem'}}>
        <thead>
          <tr>
            <th>Select</th>
            <th>Name</th>
            <th>Email</th>
            {/* Add other fields as needed */}
          </tr>
        </thead>
        <tbody>
          {approvers.map(user => (
            <tr key={user.id}>
              <td>
                <input
                  type="checkbox"
                  checked={selectedApprovers.includes(user.id)}
                  onChange={() => handleCheckboxChange(user.id)}
                />
              </td>
              <td>{user.name}</td>
              <td>{user.email}</td>
            </tr>
          ))}
        </tbody>
      </table>

      <button
        className="btn btn-success"
        onClick={handleSendForApproval}
        disabled={selectedApprovers.length === 0}
      >
        Send for Approval
      </button>

      {/* Popup Modal */}
      {showModal && (
        <>
          <div
            style={{
              position: 'fixed',
              top: '30%',
              left: '50%',
              transform: 'translate(-50%,-50%)',
              background: '#fff',
              padding: '2rem',
              borderRadius: '8px',
              boxShadow: '0 2px 12px rgba(0,0,0,0.16)',
              zIndex: 1000,
            }}
          >
            <h4>{modalMessage}</h4>
            <button onClick={handleCloseModal}>Close</button>
          </div>
          <div
            style={{
              position: 'fixed',
              top: 0, left: 0,
              width: '100vw', height: '100vh',
              background: 'rgba(0,0,0,0.2)',
              zIndex: 999,
            }}
            onClick={handleCloseModal}
          />
        </>
      )}
    </div>
  );
};

export default SendForApproval;
